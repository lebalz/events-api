datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator client {
    provider = "prisma-client-js"
    previewFeatures = ["views"]
}

generator docs {
  provider = "node node_modules/prisma-docs-generator"
  output = "../docs/prisma"
}

generator dbml {
  provider = "prisma-dbml-generator"
}

model User {
    id         String        @id @db.Uuid @default(uuid())
    email      String        @unique
    untis      UntisTeacher? @relation(fields: [untisId], references: [id])
    untisId    Int?          @unique @map("untis_id")
    firstName  String        @map("first_name")
    lastName   String        @map("last_name")
    role       Role          @default(USER)
    createdAt  DateTime      @default(now()) @map("created_at")
    updatedAt  DateTime      @updatedAt @map("updated_at")
    events     Event[]       @relation("events")
    icsLocator String?       @map("ics_locator")
    jobs       Job[]

    @@map("users")
}

model Event {
    id       String @id @db.Uuid @default(uuid())
    author   User   @relation("events", fields: [authorId], references: [id])
    authorId String @db.Uuid() @map("author_id")

    start DateTime
    end   DateTime

    location        String @default("")
    description     String @default("")
    descriptionLong String @default("") @map("description_long")

    state EventState @default(DRAFT)

    job   Job?    @relation(fields: [jobId], references: [id], onDelete: Cascade)
    jobId String? @db.Uuid() @map("import_id")

    // Filter Criterias
    classes      String[]     @default([])
    // wildcard class names
    classGroups   String[]    @default([]) @map("class_groups")
    departments  Department[] @relation("events_to_departments")
    teachersOnly Boolean      @default(false) @map("teachers_only")
    klpOnly      Boolean      @default(false) @map("klp_only")
    // teachers eith this subject
    subjects    String[]        @default([])

    teachingAffected TeachingAffected @default(YES) @map("teaching_affected")

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")
    deletedAt DateTime? @map("deleted_at")

    @@map("events")
}

model Department {
    id                String       @id @db.Uuid @default(uuid())
    name              String       @unique
    description       String       @default("")
    letter            String       @default("")
    classLetters      String[]      @default([])

    classes           UntisClass[]
    events            Event[]      @relation("events_to_departments")
    color             String       @default("#306cce")

    createdAt         DateTime @default(now()) @map("created_at")
    updatedAt         DateTime @updatedAt @map("updated_at")

    @@map("departments")
}

model Semester {
    id        String   @id @db.Uuid @default(uuid())
    name      String
    start     DateTime
    end       DateTime
    untisSyncDate DateTime
    lessons   UntisLesson[]
    jobs      Job[]
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("semesters")
}

model RegistrationPeriod {
    id        String   @id @db.Uuid @default(uuid())
    name      String
    start     DateTime
    end       DateTime
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("registration_periods")
}

model Job {
    id    String   @id @db.Uuid @default(uuid())
    type  JobType
    state JobState @default(PENDING)

    user   User   @relation(fields: [userId], references: [id])
    userId String @db.Uuid @map("user_id")
    
    // Sync Job Only
    semester   Semester?   @relation(fields: [semesterId], references: [id])
    semesterId String? @db.Uuid @map("semester_id")
    syncDate   DateTime? @map("sync_date")

    // Import Job Only
    events Event[]

    description String @default("")

    filename String?
    log      String  @default("")

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("jobs")
}

model UntisTeacher {
    id       Int           @id @default(autoincrement())
    name     String        @unique
    longName String        @map("long_name")
    title    String
    active   Boolean
    lessons  UntisLesson[] @relation("teachers_to_lessons")
    classes  UntisClass[]  @relation("teachers_to_classes")
    user     User?

    @@map("untis_teachers")
}

model UntisLesson {
    id          Int            @id @default(autoincrement())
    room        String
    subject     String
    description String
    semesterNr  Int            @map("semester_nr")
    year        Int
    weekDay     Int            @map("week_day")
    startHHMM   Int            @map("start_hhmm")
    endHHMM     Int            @map("end_hhmm")
    classes     UntisClass[]   @relation("classes_to_lessons")
    teachers    UntisTeacher[] @relation("teachers_to_lessons")
    
    semester    Semester        @relation(fields: [semesterId], references: [id])
    semesterId  String          @db.Uuid @map("semester_id")

    @@map("untis_lessons")
}

model UntisClass {
    id           Int            @id @default(autoincrement())
    name         String         @unique
    legacyName   String?        @map("legacy_name") @unique
    year         Int
    sf           String
    lessons      UntisLesson[]  @relation("classes_to_lessons")
    teachers     UntisTeacher[] @relation("teachers_to_classes")
    department   Department?    @relation(fields: [departmentId], references: [id])
    departmentId String?        @db.Uuid @map("department_id")

    @@map("untis_classes")
}

view UsersUntisView {
  uId           String @map("u_id") @db.Uuid
  uEmail        String @map("u_email")
  cId           Int    @map("c_id")
  cName         String @map("c_name")
  cNameLegacy   String @map("c_name_legacy")
  lId           Int    @map("l_id")
  lSubject      String @map("l_subject")
  lStartHHMM    Int    @map("l_start_hhmm")
  lEndHHMM      Int    @map("l_end_hhmm")
  lWeekDay      Int    @map("l_week_day")
  lSemesterId   Int    @map("l_semester_id")
  dId           String @map("d_id") @db.Uuid
  dName         String @map("d_name")

  @@unique([uId, cId, lId, dId])
  @@map("users_untis_view")
}


/// The underlying view does not contain a valid unique identifier and can therefore currently not be handled by the Prisma Client.
view EventsView {
  e_id               String @map("e_id")  @db.Uuid
  start              DateTime @map("start")
  end                DateTime @map("end")
  state              EventState @map("state")
  classes            String[] @map("classes")
  description        String @map("description")
  class_groups       String[] @map("class_groups")
  teachers_only      Boolean @map("teachers_only")
  klp_only           Boolean @map("klp_only")
  subjects           String[] @map("subjects")
  department_ids     String[] @map("department_ids") @db.Uuid
  year_s             Decimal @map("year_s") @db.Decimal
  year_e             Decimal @map("year_e") @db.Decimal
  start_week_day     Decimal @map("start_week_day") @db.Decimal
  end_week_day       Decimal @map("end_week_day") @db.Decimal
  start_offset_m     Decimal @map("start_offset_m") @db.Decimal
  end_offset_m       Decimal @map("end_offset_m") @db.Decimal
  duration_m         Decimal @map("duration_m") @db.Decimal
  s_id               String @map("s_id")  @db.Uuid

  @@unique([s_id, e_id])
  @@map("events_view")
}

view UsersTeachingView {
  lSemesterId     Int @map("l_semester_id")
  classIds          Int[] @map("class_ids")
  classNames        String[] @map("class_names")
  legacyClassNames  String[] @map("legacy_class_names")
  subjects          String[] @map("subjects")
  departmentIds     String[] @db.Uuid @map("department_ids")
  departmentNames   String[] @map("department_names")

  @@unique([lSemesterId])
  @@map("users_teaching_view")
}

enum Role {
  USER
  ADMIN
}

enum EventState {
  DRAFT
  REVIEW
  PUBLISHED
  REFUSED
}

enum TeachingAffected {
  YES
  PARTIAL
  NO
}

enum JobState {
  PENDING
  ERROR
  DONE
  REVERTED
}

enum JobType {
  IMPORT
  CLONE
  SYNC_UNTIS
}
